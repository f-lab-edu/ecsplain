name: RAG CI 

on:
  pull_request:
    branches: [develop]
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  rag-ci:
    runs-on: ubuntu-latest

    env:
      RAG_API_OPENAI_API_KEY: ${{ secrets.RAG_API_OPENAI_API_KEY }}
      RAG_API_OPENAI_BASE_URL: ${{ secrets.RAG_API_OPENAI_BASE_URL }}
      RAG_API_OPENAI_MODEL: ${{ secrets.RAG_API_OPENAI_MODEL }}
      RAG_API_EMBEDDING_MODEL: ${{ secrets.RAG_API_EMBEDDING_MODEL }}
      RAG_API_RETRIEVAL_K: ${{ secrets.RAG_API_RETRIEVAL_K }}
      RAG_API_TEMPERATURE: ${{ secrets.RAG_API_TEMPERATURE }}
      RAG_API_REASONING_EFFORT: ${{ secrets.RAG_API_REASONING_EFFORT }}
      RAG_API_CHROMA_DIR: ${{ secrets.RAG_API_CHROMA_DIR }}
      RAG_API_DATA_DIR: ${{ secrets.RAG_API_DATA_DIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies 
        run: |
          pip install --upgrade pip 
          pip install -r requirements.txt 
          pip install -r requirements.dev.txt 
      
      - name: Run ruff 
        run: ruff check . 
      
      - name: Run mypy
        run: mypy . 
      
      - name: Run unit tests 
        run: pytest -q tests 
      
      - name: Run retriever sanity tests 
        run: pytest -q tests/test_retriever_sanity.py

      - name: Run RAG E2E tests 
        run: pytest -q tests/test_rag_e2e.py
