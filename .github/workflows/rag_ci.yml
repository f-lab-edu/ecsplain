name: RAG CI 

on:
  pull_request:
    branches: [develop]
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  rag-ci:
    runs-on: ubuntu-latest

    env:
      RAG_API_OPENAI_API_KEY: ${{ secrets.RAG_API_OPENAI_API_KEY }}
      RAG_API_OPENAI_BASE_URL: ${{ secrets.RAG_API_OPENAI_BASE_URL }}
      RAG_API_OPENAI_MODEL: ${{ secrets.RAG_API_OPENAI_MODEL }}
      RAG_API_EMBEDDING_MODEL: ${{ secrets.RAG_API_EMBEDDING_MODEL }}
      RAG_API_RETRIEVAL_K: ${{ secrets.RAG_API_RETRIEVAL_K }}
      RAG_API_TEMPERATURE: ${{ secrets.RAG_API_TEMPERATURE }}
      RAG_API_REASONING_EFFORT: ${{ secrets.RAG_API_REASONING_EFFORT }}
      RAG_API_CHROMA_DIR: ${{ secrets.RAG_API_CHROMA_DIR }}
      RAG_API_DATA_DIR: ${{ secrets.RAG_API_DATA_DIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install dependencies 
        run: |
          pip install --upgrade pip 
          pip install -r requirements.txt 

      - name: Get changed Python files
        id: changed-files
        run: |
          # PR ê¸°ì¤€ base / head ì»¤ë°‹ SHA
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.sha }}"

          echo "BASE: $BASE_SHA"
          echo "HEAD: $HEAD_SHA"

          # base~head ì‚¬ì´ì—ì„œ ë³€ê²½ëœ .py íŒŒì¼ (ì‚­ì œëœ íŒŒì¼ ì œì™¸)
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR "$BASE_SHA" "$HEAD_SHA" -- '*.py')

          echo "Changed files (raw):"
          echo "$CHANGED_FILES"

          # ì¤„ë°”ê¿ˆ -> ê³µë°± ì¹˜í™˜ (Actions outputìœ¼ë¡œ ë„˜ê¸°ê¸° ìœ„í•´)
          CHANGED_FILES_ONELINE=$(echo "$CHANGED_FILES" | tr '\n' ' ')

          echo "Changed files (oneline):"
          echo "$CHANGED_FILES_ONELINE"

          # GitHub Actions outputìœ¼ë¡œ ì „ë‹¬
          echo "files=$CHANGED_FILES_ONELINE" >> "$GITHUB_OUTPUT"

      # ğŸ§¹ ë³€ê²½ëœ íŒŒì¼ì´ ìˆì„ ë•Œë§Œ ruff ì‹¤í–‰
      - name: Run ruff on changed files
        if: steps.changed-files.outputs.files != ''
        run: |
          echo "$CHANGED_FILES" | xargs ruff check

      - name: Run mypy on changed files
        if: steps.changed-files.outputs.files != ''
        run: |
          echo "$CHANGED_FILES" | xargs mypy --config-file mypy.ini
      
      - name: Run retriever sanity tests 
        run: pytest -q tests/test_retriever_sanity.py

      - name: Run RAG E2E tests 
        run: pytest -q tests/test_rag_e2e.py
